(()=>{"use strict";var e={859:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Attacher=void 0,t.Attacher=class{constructor(e){this.manager=e,this.ruleClassName="rule",this.sensorClassName="sensor",this.relayClassName="relay",this.ruleTemplate=document.getElementsByClassName(this.ruleClassName)[0],this.ruleContainer=this.ruleTemplate.parentElement,this.ruleContainer.removeChild(this.ruleTemplate),this.sensorTemplate=document.getElementsByClassName(this.sensorClassName)[0],this.sensorContainer=this.sensorTemplate.parentElement,this.sensorContainer.removeChild(this.sensorTemplate),this.relayTemplate=document.getElementsByClassName(this.relayClassName)[0],this.relayContainer=this.relayTemplate.parentElement,this.relayContainer.removeChild(this.relayTemplate);for(const t of e.rules){let e=this.ruleTemplate.cloneNode(!0);this.ruleContainer.appendChild(e),t.element=this.ruleContainer.getElementsByClassName(this.ruleClassName)[this.ruleContainer.childElementCount-1]}for(const t of e.sensors){let e=this.sensorTemplate.cloneNode(!0);this.sensorContainer.appendChild(e),t.element=this.sensorContainer.getElementsByClassName(this.sensorClassName)[this.sensorContainer.childElementCount-1]}for(const t of e.relays){let e=this.relayTemplate.cloneNode(!0);this.relayContainer.appendChild(e),t.element=this.relayContainer.getElementsByClassName(this.relayClassName)[this.relayContainer.childElementCount-1]}var t=document.getElementById("mail");e.mail_raw.bindText(t),console.log(this)}}},383:(e,t)=>{var s,a,r;Object.defineProperty(t,"__esModule",{value:!0}),t.SaveTarget=t.RelayIndexes=t.RuleType=void 0,(r=t.RuleType||(t.RuleType={}))[r.NONE=0]="NONE",r[r.TIME=1]="TIME",r[r.BUS_MAIN=2]="BUS_MAIN",r[r.BUS_MISC=3]="BUS_MISC",r[r.CPWM=4]="CPWM",r[r.rule_none=0]="rule_none",r[r.rule_time=1]="rule_time",r[r.rule_temp=2]="rule_temp",r[r.rule_humi=3]="rule_humi",r[r.rule_cpwm=4]="rule_cpwm",(a=t.RelayIndexes||(t.RelayIndexes={}))[a.TEXT=0]="TEXT",a[a.RULE=1]="RULE",a[a.STATE=2]="STATE",(s=t.SaveTarget||(t.SaveTarget={}))[s.ALL=0]="ALL",s[s.SENSOR=1]="SENSOR",s[s.RULE=2]="RULE",s[s.RELAY=3]="RELAY",s[s.MAIL=4]="MAIL"},562:(e,t)=>{function s(e,t){for(e=e.toString();e.length<t;)e="0"+e;return e}Object.defineProperty(t,"__esModule",{value:!0}),t.enableDrop=t.dateToSeconds=t.secondsToDate=t.uuidv4=t.createDragTarget=t.addRelativeCallback=t.pad=void 0,t.pad=s,t.addRelativeCallback=function(e,t,s,a){var r;r=s,e.addEventListener(t,(()=>a(r)),!1)},t.createDragTarget=function(e){e.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation()}))},t.uuidv4=function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)))},t.secondsToDate=function(e){let t=Math.floor(e/3600);e%=3600;let a=Math.floor(e/60);return e%=60,s(t,2)+":"+s(a,2)+":"+s(e,2)},t.dateToSeconds=function(e){let t=e.split(":"),s=0;return t[0]&&(s+=3600*parseInt(t[0])),t[1]&&(s+=60*parseInt(t[1])),t[2]&&(s+=parseInt(t[2])),s},t.enableDrop=function(e){e.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation()}))}},605:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Manager=void 0;const a=s(859),r=s(383),i=s(431),n=s(849),l=s(954),h=s(774),u=s(458);var o;class d extends EventTarget{constructor(){super(),this.sharedRanges=[new h.SharedRange("T",1,4,((e,t)=>{this.bus_a_names[t]=e,l.Sensor.CreateWithProperty(this.bus_a,t,0,e,o)}),!0),new h.SharedRange("T",11,14,((e,t)=>{this.bus_b_names[t]=e,l.Sensor.CreateWithProperty(this.bus_b,t,0,e,o)}),!0),new h.SharedRange("T",21,30,((e,t)=>{this.rule_names[t]=e,n.Rule.CreateWithProperty(o.rules,t,6,e,o)}),!0),new h.SharedRange("T",31,36,((e,t)=>{this.relay_names[t]=e,i.Relay.CreateWithProperty(o.relays,t,r.RelayIndexes.TEXT,e,o)}),!0),new h.SharedRange("T",41,48,((e,t)=>{this.analog_names[t]=e,l.Sensor.CreateWithProperty(this.analog,t,0,e,o,l.SensorType.ANALOG)}),!0),new h.SharedRange("T",99,99,((e,t)=>{this.mail_raw=e}),!0),new h.SharedRange("U",10,10,((e,t)=>{this.timeVar=e})),new h.SharedRange("U",11,16,((e,t)=>{this.relay_states[t]=e,i.Relay.CreateWithProperty(o.relays,t,r.RelayIndexes.STATE,e,o)})),new h.SharedRange("U",21,60,((e,t)=>{this.rule_info_raw[t]=e,n.Rule.CreateWithProperty(o.rules,Math.floor(t/4),t%4+2,e,o)}),!0),new h.SharedRange("U",70,75,((e,t)=>{this.relay_rule_index[t]=e,i.Relay.CreateWithProperty(o.relays,t,r.RelayIndexes.RULE,e,o)}),!0),new h.SharedRange("U",80,89,((e,t)=>{n.Rule.CreateWithProperty(o.rules,t,7,e,o)}),!0),new h.SharedRange("S",11,18,((e,t)=>{this.bus_a_raw[t]=e,l.Sensor.CreateWithProperty(this.bus_a,Math.floor(t/2),t%2+1,e,o)})),new h.SharedRange("S",21,28,((e,t)=>{this.bus_b_raw[t]=e,l.Sensor.CreateWithProperty(this.bus_b,Math.floor(t/2),t%2+1,e,o)})),new h.SharedRange("S",31,50,((e,t)=>{this.rule_range_raw[t]=e,n.Rule.CreateWithProperty(o.rules,Math.floor(t/2),t%2,e,o)}),!0),new h.SharedRange("S",60,75,((e,t)=>{this.analog_raw[t]=e,l.Sensor.CreateWithProperty(this.analog,Math.floor(t/2),t%2+1,e,o,l.SensorType.ANALOG)}))],this.loaded=!1,this.firstUpdateEvent=new CustomEvent("firstUpdate"),this.updateEvent=new CustomEvent("update"),this.shared={},this.sensors=[],this.bus_a=[],this.bus_a_raw=[],this.bus_a_names=[],this.bus_b=[],this.bus_b_raw=[],this.bus_b_names=[],this.rules=[],this.rule_range_raw=[],this.rule_info_raw=[],this.rule_names=[],this.relays=[],this.relay_states=[],this.relay_rule_index=[],this.relay_names=[],this.analog_names=[],this.analog_raw=[],this.analog=[],this.dragAndDrop={},this.lastDragClass="",o=this,window.manager=this,document.addEventListener("dragstart",(e=>{let t=e.target.id,s="text/"+this.dragAndDrop[t].getType();e.dataTransfer.items.add(t,s),this.lastDragClass="drag-"+this.dragAndDrop[t].getType(),document.getElementsByTagName("body")[0].classList.add(this.lastDragClass)})),document.addEventListener("drop",(e=>{let t=e.target,s=t.id;for(;t&&!s;)t=t.parentElement,s=t.id;let a=e.dataTransfer.items[0],r=e.target;a.getAsString((e=>{this.dragAndDrop[s].handleDrop(this.dragAndDrop[e],r)}))})),document.addEventListener("dragend",(e=>{document.getElementsByTagName("body")[0].classList.remove(this.lastDragClass)})),this.addEventListener("firstUpdate",this.firstUpdateHandler),this.update()}sendSharedWriteRequest(e){console.log(e);let t=new XMLHttpRequest;t.open("GET","http://192.168.1.133/sv?"+e),t.send()}save(e=r.SaveTarget.ALL){switch(e){default:case r.SaveTarget.ALL:return this.save(r.SaveTarget.SENSOR),this.save(r.SaveTarget.RULE),this.save(r.SaveTarget.RELAY),this.save(r.SaveTarget.MAIL),void this.sendSharedWriteRequest("U98=1");case r.SaveTarget.SENSOR:for(const e of this.sensors)this.sendSharedWriteRequest(e.getUrlSetter());return;case r.SaveTarget.RULE:for(const e of this.rules)this.sendSharedWriteRequest(e.getUrlSetter());return;case r.SaveTarget.RELAY:for(const e of this.relays)this.sendSharedWriteRequest(e.getUrlSetter());return;case r.SaveTarget.MAIL:return void this.sendSharedWriteRequest(this.mail_raw.getUrlSetter())}}update(){let e=new XMLHttpRequest;e.open("GET","http://192.168.1.133/shared.txt"),e.addEventListener("load",(function(){let t=e.responseText.split("|");for(let e=0;e<t.length;e+=2)o.handleSharedVar(t[e],t[e+1]);o.loaded?o.dispatchEvent(o.updateEvent):(o.dispatchEvent(o.firstUpdateEvent),o.loaded=!0)})),e.send()}handleSharedVar(e,t){if(0==e.length)return;let s=0,a=this.shared[e];if(void 0===a&&(a=new u.SharedVariable(e,s),this.shared[e]=a),a.realTime){switch(e[0]){case"e":case"u":case"S":case"U":s=parseInt(t);break;case"T":default:s=t}return a.value=s,a}}firstUpdateHandler(){console.log(this);for(const e in this.shared){let t=this.shared[e];for(const e of this.sharedRanges)e.handleSharedVar(t)}this.sensors=this.sensors.concat(this.bus_a,this.bus_b,this.analog);for(let e of this.rules.concat(this.sensors,this.relays))this.dragAndDrop[e.id]=e;this.attacher=new a.Attacher(o),o.updateInterval=setInterval(o.update,1e3)}getSensor(e){return e<this.bus_a.length?this.bus_a[e]:(e-=this.bus_a.length)<this.bus_b.length?this.bus_b[e]:this.analog[e-this.bus_b.length]}getSensorRelativeIndex(e){let t=this.bus_a.indexOf(e);return-1==t&&(t=this.bus_b.indexOf(e),-1==t?t=this.analog.indexOf(e)+this.bus_a.length+this.bus_b.length:t+=this.bus_a.length),t}}t.Manager=d},781:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Realtime=void 0;const a=s(562);t.Realtime=class{constructor(e){a.addRelativeCallback(e,"update",this,(e=>e.updateHandler())),this.id=a.uuidv4()}updateHandler(){}}},431:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Relay=void 0;const a=s(562),r=s(781);class i extends r.Realtime{constructor(e,t,s,a){super(a),this.nameVar=e,this.ruleIndexVar=t,this.stateVar=s,this.manager=a}get rule(){return this.manager.rules[this.ruleIndexVar.value]}set rule(e){this.ruleIndexVar.value=this.manager.rules.indexOf(e),-1==this.ruleIndexVar.value&&(this.ruleIndexVar.value=2147483647),this.ruleElement&&(this.rule?this.ruleElement.value=e.name:this.ruleElement.value="")}get name(){return this.nameVar.value.toString()}set name(e){this.nameVar.value=e}get element(){return this._element}set element(e){this._element=e,this.element.id=this.id,this.ruleElement=this.element.getElementsByClassName("relay-rule")[1],this.nameElement=this.element.getElementsByClassName("relay-name")[1],this.element.getElementsByTagName("button")[0].addEventListener("click",(()=>this.rule=void 0)),this.rule=this.rule,this.nameVar.bindText(this.nameElement),a.enableDrop(this.element)}getType(){return"relay"}handleDrop(e,t){if("rule"!=e.getType())return;let s=e;this.rule=s,console.log(this)}updateHandler(){}getUrlSetter(){return this.nameVar.getUrlSetter()+"&"+this.ruleIndexVar.getUrlSetter()}static CreateWithProperty(e,t,s,a,r){let n=e[t];switch(void 0===n&&(n=e[t]=new i(void 0,void 0,void 0,r)),s%3){case 0:n.nameVar=a;break;case 1:n.ruleIndexVar=a;break;case 2:n.stateVar=a}return n}}t.Relay=i},849:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Rule=void 0;const a=s(383),r=s(562),i=s(781);class n extends i.Realtime{constructor(e,t,s,a,r,i,n,l,h){super(h),this.nameVar=e,this.startVar=t,this.endVar=s,this.typeVar=a,this.targetVar=r,this.subRuleAVar=i,this.subRuleBVar=n,this.mailVar=l,this.manager=h,this._prevType=0}get name(){return this.nameVar.value.toString()}set name(e){this.nameVar.value=e}get start(){return this.startVar.value}set start(e){this.startVar.value=e}get end(){return this.endVar.value}set end(e){this.endVar.value=e}get type(){return this.typeVar.value}set type(e){this.typeVar.value=e}get target(){return this.manager.getSensor(this.targetVar.value)}set target(e){let t=this.manager.getSensorRelativeIndex(e);-1!=t&&(this.targetVar.value=t),this.sensorElement&&e&&(this.sensorElement.value=e.mainName)}get subRuleA(){return this.manager.rules[this.subRuleAVar.value]}set subRuleA(e){this.subRuleAVar.value=this.manager.rules.indexOf(e),-1==this.subRuleAVar.value&&(this.subRuleAVar.value=2147483647),this.subRuleAElement&&(this.subRuleA?this.subRuleAElement.value=this.subRuleA.name:this.subRuleAElement.value="")}get subRuleB(){return this.manager.rules[this.subRuleBVar.value]}set subRuleB(e){this.subRuleBVar.value=this.manager.rules.indexOf(e),-1==this.subRuleBVar.value&&(this.subRuleBVar.value=2147483647),this.subRuleBElement&&(this.subRuleB?this.subRuleBElement.value=this.subRuleB.name:this.subRuleBElement.value="")}getType(){return"rule"}handleDrop(e,t){switch(e.getType()){case"sensor":this.target=e;break;case"rule":let s=t.classList.contains("rule-a"),a=t.classList.contains("rule-b");s&&(this.subRuleA=e),a&&(this.subRuleB=e)}console.log(this)}static CreateWithProperty(e,t,s,a,r){let i=e[t];switch(void 0===i&&(i=e[t]=new n(void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,r)),s%8){case 0:i.startVar=a;break;case 1:i.endVar=a;break;case 2:i.typeVar=a;break;case 3:i.targetVar=a;break;case 4:i.subRuleAVar=a;break;case 5:i.subRuleBVar=a;break;case 6:i.nameVar=a;break;case 7:i.mailVar=a}return i}get element(){return this._element}set element(e){this._element=e,void 0!==this.element&&(this.element.id=this.id,this.nameElement=this.element.getElementsByClassName("rule-name")[1],this.startElement=this.element.getElementsByClassName("rule-start")[1],this.endElement=this.element.getElementsByClassName("rule-end")[1],this.sensorElement=this.element.getElementsByClassName("rule-sensor")[1],this.sensorTypeElement=this.element.getElementsByClassName("rule-sensor-type")[1],this.subRuleAElement=this.element.getElementsByClassName("rule-a")[1],this.subRuleBElement=this.element.getElementsByClassName("rule-b")[1],this.mailCheckbox=this.element.getElementsByClassName("rule-mail")[1],this.subRuleAClearButton=this.element.getElementsByClassName("rule-a")[0].getElementsByTagName("button")[0],this.subRuleBClearButton=this.element.getElementsByClassName("rule-b")[0].getElementsByTagName("button")[0],this.subRuleAClearButton.addEventListener("click",(()=>this.subRuleA=void 0)),this.subRuleBClearButton.addEventListener("click",(()=>this.subRuleB=void 0)),this.typeVar.bindSelect(this.sensorTypeElement,(()=>{this.updateStyle()})),this.mailVar.bindCheckbox(this.mailCheckbox),this.nameVar.bindText(this.nameElement),this.target=this.target,this.subRuleA=this.subRuleA,this.subRuleB=this.subRuleB,this.updateStyle(),r.enableDrop(this.element))}updateHandler(){}updateStyle(){switch(this.element.classList.remove(a.RuleType[this._prevType]),this.element.classList.add(a.RuleType[this.type]),this._prevType=this.type,this.type){case a.RuleType.BUS_MAIN:case a.RuleType.BUS_MISC:case a.RuleType.CPWM:this.startElement.type="text",this.endElement.type="text",this.startElement.value=this.start.toString(),this.endElement.value=this.end.toString();break;case a.RuleType.TIME:this.startElement.type="time",this.endElement.type="time",this.startElement.value=r.secondsToDate(this.start),this.endElement.value=r.secondsToDate(this.end)}}getUrlSetter(){return this.startVar.set(this.startElement.value,this.type),this.endVar.set(this.endElement.value,this.type),this.nameVar.getUrlSetter()+"&"+this.startVar.getUrlSetter()+"&"+this.endVar.getUrlSetter()+"&"+this.typeVar.getUrlSetter()+"&"+this.targetVar.getUrlSetter()+"&"+this.subRuleAVar.getUrlSetter()+"&"+this.subRuleBVar.getUrlSetter()+"&"+this.mailVar.getUrlSetter()}}t.Rule=n},954:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SensorType=t.Sensor=void 0;const a=s(781);class r extends a.Realtime{constructor(e,t,s,a,r,n=i.GENERAL){super(r),this.mainNameVar=e,this.miscNameVar=t,this.mainVar=s,this.miscVar=a,this.manager=r,this.type=n}get main(){return this.mainVar.value}get misc(){return this.miscVar.value}get mainName(){return this.mainNameVar.value.toString()}set mainName(e){this.mainNameVar.value=e}get element(){return this._element}set element(e){if(this._element=e,void 0!==this.element&&(this.element.id=this.id,this.sensorMain=this.element.getElementsByClassName("sensor-main")[1],this.sensorMisc=this.element.getElementsByClassName("sensor-misc")[1],this.sensorName=this.element.querySelector("input.sensor-name-main"),this.sensorName&&this.mainNameVar))switch(this.type){case i.GENERAL:this.mainNameVar.bindText(this.sensorName);break;case i.ANALOG:this.sensorName.value=this.mainNameVar._value.toString(),this.sensorName.setAttribute("readonly","true")}}getType(){return"sensor"}handleDrop(e,t){throw new Error("Method not implemented.")}static CreateWithProperty(e,t,s,a,n,l=i.GENERAL){let h=e[t];switch(void 0===h&&(h=e[t]=new r(void 0,void 0,void 0,void 0,n,l)),s%3){case 0:h.mainNameVar=a;break;case 1:h.mainVar=a;break;case 2:h.miscVar=a}return h}getUrlSetter(){return this.type==i.ANALOG?"U99=0":this.mainNameVar.getUrlSetter()}updateHandler(){this.sensorMain&&this.mainVar&&(this.sensorMain.innerHTML=this.main.toString()),this.sensorMisc&&this.miscVar&&(this.sensorMisc.innerHTML=this.misc.toString())}}var i;t.Sensor=r,function(e){e[e.GENERAL=0]="GENERAL",e[e.ANALOG=1]="ANALOG"}(i=t.SensorType||(t.SensorType={}))},774:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SharedRange=void 0,t.SharedRange=class{constructor(e,t,s,a,r=!1){this.prefix=e,this.start=t,this.end=s,this.callback=a,this.onlyOnce=r}handleSharedVar(e){e.name[0]==this.prefix&&this.start<=e.index&&e.index<=this.end&&(e.realTime=!this.onlyOnce,this.callback(e,e.index-this.start))}}},458:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SharedVariable=void 0;const a=s(383),r=s(562);var i;t.SharedVariable=class{constructor(e,t){this.realTime=!0,this.name=e,this.value=t,this.index=parseInt(e.slice(1))}get value(){return this._value}set value(e){if(this._value=e,void 0!==this._target)switch(this._type){case i.Text:this._target.value=e.toString();break;case i.Select:this._target.options.selectedIndex=e;break;case i.Checkbox:this._target.checked=!!e}}getUrlSetter(){return this.name+"="+this.value}set(e,t){switch(t){case a.RuleType.BUS_MAIN:case a.RuleType.BUS_MISC:case a.RuleType.CPWM:this._value=parseInt(e);break;case a.RuleType.TIME:this._value=r.dateToSeconds(e)}}bindText(e,t=null){this._type=i.Text,this._target=e,r.addRelativeCallback(this._target,"change",this,(e=>{e._value=e._target.value,t&&t(),console.log(e)})),this.value=this.value}bindCheckbox(e,t=null){this._type=i.Checkbox,this._target=e,r.addRelativeCallback(this._target,"change",this,(e=>{e._value=e._target.checked?1:0,t&&t(),console.log(e)})),this.value=this.value}bindSelect(e,t=null){this._type=i.Select,this._target=e,r.addRelativeCallback(this._target,"change",this,(e=>{e._value=e._target.options.selectedIndex,t&&t(),console.log(e)})),this.value=this.value}},function(e){e[e.Text=0]="Text",e[e.Select=1]="Select",e[e.Checkbox=2]="Checkbox"}(i||(i={}))}},t={};new(function s(a){var r=t[a];if(void 0!==r)return r.exports;var i=t[a]={exports:{}};return e[a](i,i.exports,s),i.exports}(605).Manager)})();